/*! phwoolcon sso.min.js v1.0-dev https://github.com/phwoolcon/auth | Apache-2.0 */
!function(e,t){function i(e){r("Client login"),r(e),y.notifyField.value=e,y.submit(),r("App notification sent")}function n(){w.clientUid&&r("Client logout"),_.setUid(null),y.notifyField.value="",y.submit(),r("App notification sent")}function o(e){var t=s(e.data);r("Handle in client"),t.login&&i(t.login),t.setUid&&_.setUid(t.setUid),t.logout&&n()}function r(t){e.console&&C.debug&&(e.console.trace?e.console.trace(t):e.console.log(t))}function s(t){var i;try{return i=e.JSON.parse(t)}catch(n){return t}}function c(t){return e.JSON.stringify(t)}function a(e,t,i){"addEventListener"in e?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}function l(e,t){e.postMessage("string"==typeof t?t:c(t),v)}function d(){var t=w.clientUid,i=_.getUid();U=e.parent,k=setTimeout(function(){d.apply(_)},1e3),t!=i&&(r("Server uid: "+i),i?(r("Login: "+i),S.post(C.ssoServer+C.ssoServerCheckUri,{notifyUrl:C.notifyUrl,initTime:C.initTime,initToken:C.initToken},function(e){w.clientUid=i,r(e),l(U,{login:e.user_data})},"json"),l(U,{setUid:i})):(t&&r("Logout"),w.clientUid=null,l(U,{logout:!0})))}function u(e){var t,i,n=s(e.data);(i=n.setOptions)&&_.setOptions(i),r("Handle in iframe"),(t=n.clientUid)&&(r("Aware client uid: "+t),w.clientUid=t),n.check&&d.apply(_),n.stopCheck&&(r("Stop checking"),clearTimeout(k))}e.$p||(e.$p={options:{ssoCheckUri:"sso/check",ssoServerCheckUri:"sso/server-check",baseUrl:"/"}});var p,f,g,h,U,m,y,v,k,S=e.jQuery,C={ssoServer:$p.options.baseUrl,ssoCheckUri:$p.options.ssoCheckUri,ssoServerCheckUri:$p.options.ssoServerCheckUri,initToken:"",initTime:0,notifyUrl:"",debug:!1},T="_sso_client_iframe_"+ +new Date,w={},O=e.simpleStorage||{get:function(t){return e.localStorage?s(e.localStorage.getItem("_sso_"+t)):!1},set:function(t,i){return e.localStorage?e.localStorage.setItem("_sso_"+t,c(i)):!1}},_=e.$p.sso={options:C,init:function(i){if(_.setOptions(i),!p)if(p=!0,f=t.getElementsByTagName("body")[0],$p.options.isSsoServer)v=t.referrer,a(e,"message",function(e){u.apply(_,[e])});else{v=C.ssoServer,a(e,"message",function(e){o.apply(_,[e])}),g=t.createElement("iframe"),g.width=g.height=g.frameBorder=0,g.style.display="none",g.name=T,g.src="",f.appendChild(g);var n=t.createElement("input");n.type="hidden",n.name="sso_user_data",y=t.createElement("form"),y.action=C.notifyUrl,y.style.display="none",y.method="POST",y.target=T,y.appendChild(n),y.notifyField=n,f.appendChild(y)}},setOptions:function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&(C[t]=e[t]);return _},check:function(){if(!p)throw new Error("Please invoke $p.sso.init() first.");r("Start checking");var e=_.getUid(),i={clientUid:e,check:!0,setOptions:{debug:C.debug,initToken:C.initToken,initTime:C.initTime,notifyUrl:C.notifyUrl}};return h?m&&l(m,i):(h=t.createElement("iframe"),h.src=C.ssoServer+C.ssoCheckUri,h.width=h.height=h.frameBorder=0,h.style.display="none",a(h,"load",function(){m=h.contentWindow,l(m,i)}),void f.appendChild(h))},stopCheck:function(){l(m,{stopCheck:!0})},getUid:function(){return O&&O.get("uid")},setUid:function(e,t){r("Set uid: "+e),O&&O.set("uid",e,{TTL:t||0})}};if(!e.JSON)throw new Error("Please include JSON support script to your page.");a(e,"load",function(){_.init()})}(window,document);